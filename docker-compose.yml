version: "3"
services:
  selenium-hub:
    image: selenium/hub:latest
    container_name: selenium-hub
    ports:
      # משתמש במשתנה 4445 מה-Jenkinsfile עבור הגישה החיצונית
      - "${SELENIUM_PORT}:4444"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/wd/hub/status"] 
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  chrome:
    image: selenium/node-chrome:latest
    shm_size: 2gb
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443

  firefox:
    image: selenium/node-firefox:latest
    shm_size: 2gb
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443

  test-runner:
    build: .
    container_name: test-runner  # תיקנתי לשם אחיד, לא חובה אבל מומלץ
    depends_on:
      selenium-hub:
        condition: service_healthy
      chrome:
        condition: service_started
    environment:
      # --- תיקון קריטי 1: התאמה לקוד פייתון ---
      # הפייתון שלך (conftest.py) מצפה ל-HUB_HOST ול-SELENIUM_PORT בנפרד
      # לא ל-SELENIUM_HUB_URL
      - HUB_HOST=${HUB_HOST}
      
      # --- תיקון קריטי 2: מלכודת הפורט ---
      # הטסט רץ בתוך הרשת הפנימית, שם הפורט הוא תמיד 4444.
      # המשתנה SELENIUM_PORT מכיל 4445 (חיצוני), ולכן אסור להשתמש בו כאן!
      - SELENIUM_PORT=4444
      
    # --- תיקון קריטי 3: מחיקת ה-Volumes ---
    # ב-Jenkinsfile אנחנו משתמשים ב-docker cp.
    # אם תשאיר את זה, יהיו לך בעיות הרשאה קשות בג'נקינס.
    # volumes:  <-- נמחק
    #   - ./reports:/app/reports
    #   - ./allure-results:/app/allure-results